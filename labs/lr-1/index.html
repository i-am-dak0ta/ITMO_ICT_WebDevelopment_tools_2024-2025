
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../../practices/pr-1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Lr1 - Web Programming Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-fastapi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Web Programming Docs" class="md-header__button md-logo" aria-label="Web Programming Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Web Programming Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lr1
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Web Programming Docs" class="md-nav__button md-logo" aria-label="Web Programming Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Web Programming Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lr1
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lr1
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      Цели
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Практическая часть
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Практическая часть">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Описание приложения на тему "Разработка сервиса для управления личными финансами"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Описание приложения на тему "Разработка сервиса для управления личными финансами"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Структура базы данных
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      Реализация кода
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Реализация кода">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectionpy" class="md-nav__link">
    <span class="md-ellipsis">
      Подключение к базе данных (connection.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      Главный файл приложения (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelspy" class="md-nav__link">
    <span class="md-ellipsis">
      Модели базы данных (models.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-schemaspy" class="md-nav__link">
    <span class="md-ellipsis">
      Схемы Pydantic (schemas.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersauthpy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты авторизации (routers/auth.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersuserspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты пользователей (routers/users.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersbudgetspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты бюджетов (routers/budgets.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      Пример использования:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      Результат
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pr1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Pr1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pr1_1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pr1_2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pr1_3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      Цели
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Практическая часть
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Практическая часть">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Описание приложения на тему "Разработка сервиса для управления личными финансами"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Описание приложения на тему "Разработка сервиса для управления личными финансами"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Структура базы данных
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      Реализация кода
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Реализация кода">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectionpy" class="md-nav__link">
    <span class="md-ellipsis">
      Подключение к базе данных (connection.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      Главный файл приложения (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelspy" class="md-nav__link">
    <span class="md-ellipsis">
      Модели базы данных (models.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-schemaspy" class="md-nav__link">
    <span class="md-ellipsis">
      Схемы Pydantic (schemas.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersauthpy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты авторизации (routers/auth.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersuserspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты пользователей (routers/users.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersbudgetspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты бюджетов (routers/budgets.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      Пример использования:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      Результат
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="1-fastapi">Лабораторная работа 1. Реализация серверного приложения FastAPI</h1>
<h2 id="_1">Цели</h2>
<p>Научится реализовывать полноценное серверное приложение с помощью фреймворка FastAPI с применением дополнительных средств и библиотек.</p>
<h2 id="_2">Практическая часть</h2>
<h3 id="_3">Описание приложения на тему "Разработка сервиса для управления личными финансами"</h3>
<h4 id="_4">Структура базы данных</h4>
<p><img alt="Схема БД" src="../../assets/lr-1/DB_Schema.jpg" /></p>
<p>Модель данных включает 8 таблиц:
1. Users - пользователи.
2. TransactionTypes - типы транзакций.
3. Categories - категории транзакций.
4. Budgets - бюджеты пользователей.
5. Notifications - уведомления.
6. Tags - теги для транзакций.
7. Transactions - транзакции.</p>
<p>Связи:
- One-to-Many: <code>Users</code> → <code>Transactions</code>, <code>Users</code> → <code>Budgets</code>, <code>Users</code> → <code>Notifications</code>.
- Many-to-Many: <code>Transactions</code> ↔ <code>Tags</code> через ассоциативную таблицу <code>TransactionTags</code>.
- Ассоциативная сущность: <code>TransactionTags</code>.</p>
<h3 id="_5">Реализация кода</h3>
<h4 id="connectionpy">Подключение к базе данных (<code>connection.py</code>)</h4>
<p>Файл настраивает подключение к базе данных, инициализирует таблицы и добавляет начальные данные для категорий, типов транзакций и тегов:</p>
<pre><code class="language-python">import os  
from dotenv import load_dotenv  
from sqlmodel import SQLModel, Session, create_engine, select  

from models import Categories, Tags, TransactionTypeEnums, TransactionTypes  

load_dotenv()  
db_url = os.getenv(&quot;DB_ADMIN&quot;)  
engine = create_engine(db_url, echo = True)  
DEFAULT_TAGS = [&quot;impulse_buy&quot;, &quot;planned_buy&quot;, &quot;cash&quot;, &quot;card&quot;]  
DEFAULT_TRANSACTION_TYPES = [&quot;income&quot;, &quot;expense&quot;]  
DEFAULT_CATEGORIES = {  
    &quot;expense&quot;: [  
        {&quot;name&quot;: &quot;groceries&quot;},  
        {&quot;name&quot;: &quot;transport&quot;},  
        {&quot;name&quot;: &quot;housing&quot;},  
        {&quot;name&quot;: &quot;health&quot;},  
        {&quot;name&quot;: &quot;entertainment&quot;},  
        {&quot;name&quot;: &quot;other_expenses&quot;},  
    ],  
    &quot;income&quot;: [  
        {&quot;name&quot;: &quot;salary&quot;},  
        {&quot;name&quot;: &quot;investments&quot;},  
    ],  
}  


def init_db():  
    SQLModel.metadata.create_all(engine)  
    init_default_tags()  
    init_default_transaction_types()  
    init_default_categories()  


def init_default_tags():  
    with Session(engine) as session:  
        for tag_name in DEFAULT_TAGS:  
            tag_exists = session.exec(select(Tags).where(Tags.name == tag_name)).first()  
            if not tag_exists:  
                session.add(Tags(name = tag_name))  
        session.commit()  


def init_default_transaction_types():  
    with Session(engine) as session:  
        for tt_name in DEFAULT_TRANSACTION_TYPES:  
            type_exists = session.exec(  
                select(TransactionTypes).where(TransactionTypes.name == tt_name)  
            ).first()  
            if not type_exists:  
                session.add(TransactionTypes(name=tt_name))  
        session.commit()  


def init_default_categories():  
    with Session(engine) as session:  
        for tx_type_str, categories in DEFAULT_CATEGORIES.items():  
            tx_type = session.exec(  
                select(TransactionTypes).where(TransactionTypes.name == TransactionTypeEnums(tx_type_str))  
            ).first()  

            if not tx_type:  
                continue  

            for category in categories:  
                exists = session.exec(  
                    select(Categories).where(  
                        Categories.name == category[&quot;name&quot;],  
                        Categories.transaction_type_id == tx_type.transaction_type_id  
                    )  
                ).first()  

                if not exists:  
                    session.add(  
                        Categories(  
                            name = category[&quot;name&quot;],  
                            transaction_type_id = tx_type.transaction_type_id  
                        )  
                    )  

        session.commit()  


def get_session():  
    with Session(engine) as session:  
        yield session
</code></pre>
<h4 id="mainpy">Главный файл приложения (<code>main.py</code>)</h4>
<p>Создает приложение FastAPI, подключает маршруты и инициализирует базу данных при запуске:</p>
<pre><code class="language-python">from fastapi import FastAPI  

from connection import init_db  
from routers import auth, budgets, categories, notifications, tags, transactions, users  

app = FastAPI()  


@app.on_event(&quot;startup&quot;)  
def on_startup():  
    init_db()  


app.include_router(auth.router)  
app.include_router(budgets.router)  
app.include_router(categories.router)  
app.include_router(notifications.router)  
app.include_router(tags.router)  
app.include_router(transactions.router)  
app.include_router(users.router)  


@app.get(&quot;/&quot;)  
def hello():  
    return &quot;Hello, Artur!&quot;
</code></pre>
<h4 id="modelspy">Модели базы данных (<code>models.py</code>)</h4>
<p>Определены модели с учётом связей:</p>
<pre><code class="language-python">from typing import Optional, List  
from sqlmodel import SQLModel, Field, Relationship  
from datetime import datetime  
from enum import Enum  


class Users(SQLModel, table = True):  
    user_id: Optional[int] = Field(default = None, primary_key = True)  
    username: str = Field(index = True, unique = True)  
    password: str  
    first_name: str  
    last_name: str  
    email: str = Field(unique = True, index = True)  

    transactions: List[&quot;Transactions&quot;] = Relationship(back_populates = &quot;user&quot;)  
    budgets: List[&quot;Budgets&quot;] = Relationship(back_populates = &quot;user&quot;)  
    notifications: List[&quot;Notifications&quot;] = Relationship(back_populates = &quot;user&quot;)  


class TransactionTypeEnums(str, Enum):  
    income = &quot;income&quot;  
    expense = &quot;expense&quot;  


class TransactionTypes(SQLModel, table = True):  
    transaction_type_id: Optional[int] = Field(default = None, primary_key = True)  
    name: TransactionTypeEnums  

    transactions: List[&quot;Transactions&quot;] = Relationship(back_populates = &quot;transaction_type&quot;)  
    categories: List[&quot;Categories&quot;] = Relationship(back_populates = &quot;transaction_type&quot;)  


class Categories(SQLModel, table = True):  
    category_id: Optional[int] = Field(default = None, primary_key = True)  
    transaction_type_id: Optional[int] = Field(default = None, foreign_key = &quot;transactiontypes.transaction_type_id&quot;)  
    name: str  

    transactions: List[&quot;Transactions&quot;] = Relationship(back_populates = &quot;category&quot;)  
    budgets: List[&quot;Budgets&quot;] = Relationship(back_populates = &quot;category&quot;)  
    transaction_type: Optional[&quot;TransactionTypes&quot;] = Relationship(back_populates = &quot;categories&quot;)  


class Budgets(SQLModel, table = True):  
    budget_id: Optional[int] = Field(default = None, primary_key = True)  
    user_id: Optional[int] = Field(foreign_key = &quot;users.user_id&quot;)  
    category_id: Optional[int] = Field(foreign_key = &quot;categories.category_id&quot;)  
    limit_amount: float  
    start_date: datetime  
    end_date: datetime  
    description: Optional[str] = None  
    total_spent: float = Field(default = 0.0)  

    user: Optional[&quot;Users&quot;] = Relationship(back_populates = &quot;budgets&quot;)  
    category: Optional[&quot;Categories&quot;] = Relationship(back_populates = &quot;budgets&quot;)  
    notifications: List[&quot;Notifications&quot;] = Relationship(back_populates = &quot;budget&quot;)  


class Notifications(SQLModel, table = True):  
    notification_id: Optional[int] = Field(default = None, primary_key = True)  
    user_id: Optional[int] = Field(foreign_key = &quot;users.user_id&quot;)  
    budget_id: Optional[int] = Field(foreign_key = &quot;budgets.budget_id&quot;)  
    message: str  
    created_at: datetime = Field(default_factory = datetime.utcnow)  
    is_read: bool = Field(default = False)  

    user: Optional[&quot;Users&quot;] = Relationship(back_populates = &quot;notifications&quot;)  
    budget: Optional[&quot;Budgets&quot;] = Relationship(back_populates = &quot;notifications&quot;)  


class TransactionTags(SQLModel, table = True):  
    transaction_tag_id: Optional[int] = Field(default = None, primary_key = True)  
    tag_id: Optional[int] = Field(foreign_key = &quot;tags.tag_id&quot;)  
    transaction_id: Optional[int] = Field(foreign_key = &quot;transactions.transaction_id&quot;)  
    created_at: datetime = Field(default_factory = datetime.utcnow)  


class Tags(SQLModel, table = True):  
    tag_id: Optional[int] = Field(default = None, primary_key = True)  
    name: str  

    transactions: List[&quot;Transactions&quot;] = Relationship(back_populates = &quot;tags&quot;, link_model = TransactionTags)  


class Transactions(SQLModel, table = True):  
    transaction_id: Optional[int] = Field(default = None, primary_key = True)  
    user_id: Optional[int] = Field(foreign_key = &quot;users.user_id&quot;)  
    transaction_type_id: Optional[int] = Field(foreign_key = &quot;transactiontypes.transaction_type_id&quot;)  
    category_id: Optional[int] = Field(foreign_key = &quot;categories.category_id&quot;)  
    amount: float  
    date: datetime  
    description: Optional[str] = None  

    user: Optional[&quot;Users&quot;] = Relationship(back_populates = &quot;transactions&quot;)  
    transaction_type: Optional[&quot;TransactionTypes&quot;] = Relationship(back_populates = &quot;transactions&quot;)  
    category: Optional[&quot;Categories&quot;] = Relationship(back_populates = &quot;transactions&quot;)  
    tags: List[&quot;Tags&quot;] = Relationship(back_populates = &quot;transactions&quot;, link_model = TransactionTags)
</code></pre>
<h4 id="pydantic-schemaspy">Схемы Pydantic (<code>schemas.py</code>)</h4>
<p>Определены модели для валидации данных:</p>
<pre><code class="language-python">from pydantic import BaseModel, EmailStr, field_validator, validator
from typing import Optional, List
from datetime import datetime

from pydantic_core.core_schema import ValidationInfo


class UserBase(BaseModel):
    username: str
    first_name: str
    last_name: str
    email: EmailStr


class UserCreate(UserBase):
    password: str


class UserRead(UserBase):
    user_id: int

    class Config:
        from_attributes = True


class UserWithToken(BaseModel):
    user: UserRead
    access_token: str
    token_type: str = &quot;bearer&quot;


class UserUpdate(BaseModel):
    first_name: Optional[str]
    last_name: Optional[str]
    email: Optional[EmailStr]


class UserLogin(BaseModel):
    username: str
    password: str


class UserPassword(BaseModel):
    old_password: str
    new_password: str


class TransactionBase(BaseModel):
    amount: float
    date: datetime
    description: Optional[str] = None


class TransactionCreate(TransactionBase):
    transaction_type_id: int
    category_id: int
    tag_ids: Optional[List[int]] = []

    @field_validator('amount')
    def amount_must_be_positive(cls, amount: float):
        if amount &lt;= 0:
            raise ValueError('Amount must be positive')
        return amount


class TransactionUpdate(BaseModel):
    transaction_type_id: Optional[int]
    category_id: Optional[int]
    amount: Optional[float]
    date: Optional[datetime]
    description: Optional[str] = None
    tag_ids: Optional[List[int]]

    @field_validator('amount')
    def amount_must_be_positive(cls, amount: Optional[float]):
        if amount is not None and amount &lt;= 0:
            raise ValueError('Amount must be positive')
        return amount


class TransactionRead(TransactionBase):
    transaction_id: int
    user_id: int
    transaction_type_id: int
    category_id: int
    tags: List['TagRead'] = []

    class Config:
        from_attributes = True


class BudgetBase(BaseModel):
    limit_amount: float
    start_date: datetime
    end_date: datetime
    description: Optional[str] = None


class BudgetCreate(BudgetBase):
    category_id: int

    @field_validator('limit_amount')
    def limit_amount_must_be_positive(cls, limit_amount: float):
        if limit_amount &lt;= 0:
            raise ValueError('Limit amount must be positive')
        return limit_amount

    @field_validator('end_date')
    def check_dates(cls, end_date: datetime, info: ValidationInfo):
        start_date = info.data.get('start_date')  # type: ignore
        if start_date and end_date &lt;= start_date:
            raise ValueError('End date must be after start date')
        return end_date


class BudgetUpdate(BaseModel):
    category_id: Optional[int]
    limit_amount: Optional[float]
    start_date: Optional[datetime]
    end_date: Optional[datetime]
    description: Optional[str] = None

    @field_validator('limit_amount')
    def limit_amount_must_be_positive(cls, limit_amount: Optional[float]):
        if limit_amount is not None and limit_amount &lt;= 0:
            raise ValueError('Limit amount must be positive')
        return limit_amount

    @field_validator('end_date')
    def check_dates(cls, end_date: datetime, info: ValidationInfo):
        start_date = info.data.get('start_date')  # type: ignore
        if start_date and end_date &lt;= start_date:
            raise ValueError('End date must be after start date')
        return end_date


class BudgetRead(BudgetBase):
    budget_id: int
    user_id: int
    category_id: int
    total_spent: float

    class Config:
        from_attributes = True


class NotificationRead(BaseModel):
    notification_id: int
    user_id: int
    budget_id: int
    message: str
    created_at: datetime
    is_read: bool

    class Config:
        from_attributes = True


class CategoryBase(BaseModel):
    name: str


class CategoryRead(CategoryBase):
    category_id: int
    transaction_type_id: int

    class Config:
        from_attributes = True


class TagBase(BaseModel):
    name: str


class TagRead(TagBase):
    tag_id: int

    class Config:
        from_attributes = True


class TransactionTagRead(BaseModel):
    transaction_tag_id: int
    tag_id: int
    transaction_id: int
    created_at: datetime

    class Config:
        from_attributes = True

</code></pre>
<h4 id="routersauthpy">Маршруты авторизации (<code>routers/auth.py</code>)</h4>
<p>Реализованы функции регистрации, логина, проверки токенов и управления паролем:</p>
<pre><code class="language-python">import datetime
import os
import jwt
from fastapi import APIRouter, HTTPException, Depends, Security, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlmodel import Session, select
from passlib.context import CryptContext
from connection import get_session
from models import Users
from schemas import UserCreate, UserRead, UserLogin, UserPassword, UserWithToken

router = APIRouter(prefix = &quot;/auth&quot;, tags = [&quot;Authentication&quot;])

SECRET_KEY = os.getenv(&quot;SECRET_KEY&quot;)
ALGORITHM = os.getenv(&quot;ALGORITHM&quot;)
ACCESS_TOKEN_EXPIRE_MINUTES = 30

pwd_context = CryptContext(schemes = [&quot;bcrypt&quot;], deprecated = &quot;auto&quot;)
auth_scheme = HTTPBearer()


def create_access_token(data: dict, expires_delta: datetime.timedelta = None) -&gt; str:
    payload = data.copy()
    if expires_delta:
        expire = datetime.datetime.now(datetime.timezone.utc) + expires_delta
    else:
        expire = datetime.datetime.now(datetime.timezone.utc) + datetime.timedelta(
            minutes = ACCESS_TOKEN_EXPIRE_MINUTES
        )
    payload.update({&quot;exp&quot;: expire})
    encoded_jwt = jwt.encode(payload, SECRET_KEY, algorithm = ALGORITHM)
    return encoded_jwt


def verify_token(token: str) -&gt; str:
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms = [ALGORITHM])
        return payload.get(&quot;sub&quot;)
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code = status.HTTP_401_UNAUTHORIZED, detail = &quot;Token expired&quot;)
    except jwt.InvalidTokenError:
        raise HTTPException(status_code = status.HTTP_401_UNAUTHORIZED, detail = &quot;Invalid token&quot;)


def create_user_with_hash(user_create: UserCreate, session: Session) -&gt; Users:
    username_statement = select(Users).where(Users.username == user_create.username)
    existing_user = session.exec(username_statement).first()
    if existing_user:
        raise HTTPException(status_code = 400, detail = &quot;Username already registered&quot;)

    email_statement = select(Users).where(Users.email == user_create.email)
    existing_email = session.exec(email_statement).first()
    if existing_email:
        raise HTTPException(status_code = 400, detail = &quot;Email already registered&quot;)

    hashed_password = pwd_context.hash(user_create.password)

    new_user = Users(
        username = user_create.username,
        password = hashed_password,
        first_name = user_create.first_name,
        last_name = user_create.last_name,
        email = user_create.email
    )
    session.add(new_user)
    session.commit()
    session.refresh(new_user)
    return new_user


def create_user_and_token(user_create: UserCreate, session: Session) -&gt; UserWithToken:
    user = create_user_with_hash(user_create, session)
    token = create_access_token(data = {&quot;sub&quot;: user.username})
    return UserWithToken(user = UserRead.model_validate(user), access_token = token)


@router.post(&quot;/register&quot;, response_model = UserWithToken)
def register(user_create: UserCreate, session: Session = Depends(get_session)):
    return create_user_and_token(user_create, session)


@router.post(&quot;/login&quot;, response_model = UserWithToken)
def login(user_login: UserLogin, session: Session = Depends(get_session)):
    statement = select(Users).where(Users.username == user_login.username)
    user = session.exec(statement).first()
    if not user or not pwd_context.verify(user_login.password, user.password):
        raise HTTPException(status_code = 401, detail = &quot;Invalid credentials&quot;)
    token = create_access_token(data = {&quot;sub&quot;: user.username})
    return {
        &quot;user&quot;: UserRead.model_validate(user),
        &quot;access_token&quot;: token,
        &quot;token_type&quot;: &quot;bearer&quot;
    }


def get_current_user(
    credentials: HTTPAuthorizationCredentials = Security(auth_scheme),
    session: Session = Depends(get_session)
) -&gt; Users:
    token = credentials.credentials
    username = verify_token(token)
    statement = select(Users).where(Users.username == username)
    user = session.exec(statement).first()
    if not user: raise HTTPException(status_code = 404, detail = &quot;User not found&quot;)
    return user


@router.get(&quot;/me&quot;, response_model = UserRead)
def read_current_user(current_user: Users = Depends(get_current_user)):
    return current_user


@router.patch(&quot;/change-password&quot;)
def change_password(
    pwd_data: UserPassword,
    current_user: Users = Depends(get_current_user),
    session: Session = Depends(get_session)
):
    if not pwd_context.verify(pwd_data.old_password, current_user.password):
        raise HTTPException(status_code = 400, detail = &quot;Incorrect current password&quot;)
    current_user.password = pwd_context.hash(pwd_data.new_password)
    session.add(current_user)
    session.commit()
    return {&quot;message&quot;: &quot;Password updated successfully&quot;}

</code></pre>
<h4 id="routersuserspy">Маршруты пользователей (<code>routers/users.py</code>)</h4>
<p>Реализованы CRUD-операции для пользователей:</p>
<pre><code class="language-python">from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session, select
from connection import get_session
from models import Users
from typing import List
from routers.auth import create_user_and_token
from schemas import UserCreate, UserRead, UserUpdate, UserWithToken

router = APIRouter(prefix = &quot;/users&quot;, tags = [&quot;Users&quot;])


@router.post(&quot;/&quot;, response_model = UserWithToken)
def create_user(user_create: UserCreate, session: Session = Depends(get_session)):
    return create_user_and_token(user_create, session)


@router.get(&quot;/&quot;, response_model = List[UserRead])
def read_users(session: Session = Depends(get_session)):
    users = session.exec(select(Users)).all()
    return users


@router.get(&quot;/{user_id}&quot;, response_model = UserRead)
def read_user(user_id: int, session: Session = Depends(get_session)):
    user = session.get(Users, user_id)
    if not user:
        raise HTTPException(status_code = 404, detail = &quot;User not found&quot;)
    return user


@router.patch(&quot;/{user_id}&quot;, response_model = UserRead)
def update_user(user_id: int, user_update: UserUpdate, session: Session = Depends(get_session)):
    user = session.get(Users, user_id)
    if not user:
        raise HTTPException(status_code = 404, detail = &quot;User not found&quot;)
    user_data = user_update.dict(exclude_unset = True)
    for key, value in user_data.items():
        setattr(user, key, value)
    session.add(user)
    session.commit()
    session.refresh(user)
    return user


@router.delete(&quot;/{user_id}&quot;)
def delete_user(user_id: int, session: Session = Depends(get_session)):
    user = session.get(Users, user_id)
    if not user:
        raise HTTPException(status_code = 404, detail = &quot;User not found&quot;)
    session.delete(user)
    session.commit()
    return {&quot;message&quot;: &quot;User deleted successfully&quot;}

</code></pre>
<h4 id="routersbudgetspy">Маршруты бюджетов (<code>routers/budgets.py</code>)</h4>
<p>Реализованы CRUD-операции для бюджетов с автоматическим обновлением расходов и уведомлений:</p>
<pre><code class="language-python">from fastapi import APIRouter, Depends, HTTPException  
from sqlalchemy import delete, func  
from sqlmodel import Session, select  
from connection import get_session  
from models import Budgets, Categories, Notifications, TransactionTypeEnums, TransactionTypes, Transactions, Users  
from schemas import BudgetCreate, BudgetRead, BudgetUpdate  
from routers.auth import get_current_user  
from typing import List  

router = APIRouter(prefix = &quot;/budgets&quot;, tags = [&quot;Budgets&quot;])  


@router.post(&quot;/&quot;, response_model = BudgetRead)  
def create_budget(  
    budget: BudgetCreate,  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    category = session.get(Categories, budget.category_id)  
    if not category:  
        raise HTTPException(status_code = 404, detail = &quot;Category not found&quot;)  
    if category.transaction_type.name != TransactionTypeEnums.expense:  
        raise HTTPException(status_code = 400, detail = &quot;Budget can only be set for expense categories&quot;)  

    db_budget = Budgets(  
        user_id = current_user.user_id,  
        category_id = budget.category_id,  
        limit_amount = budget.limit_amount,  
        start_date = budget.start_date,  
        end_date = budget.end_date,  
        description = budget.description  
    )  
    session.add(db_budget)  
    session.commit()  
    session.refresh(db_budget)  

    update_total_spent(  
        category_id = budget.category_id,  
        user_id = current_user.user_id,  
        session = session  
    )  

    return db_budget  


@router.get(&quot;/&quot;, response_model = List[BudgetRead])  
def read_budgets(  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    statement = select(Budgets).where(Budgets.user_id == current_user.user_id)  
    budgets = session.exec(statement).all()  
    return budgets  


@router.get(&quot;/{budget_id}&quot;, response_model = BudgetRead)  
def read_budget(  
    budget_id: int,  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    budget = session.get(Budgets, budget_id)  
    if not budget:  
        raise HTTPException(status_code = 404, detail = &quot;Budget not found&quot;)  
    if budget.user_id != current_user.user_id:  
        raise HTTPException(status_code = 403, detail = &quot;Not authorized to view this budget&quot;)  
    return budget  


def update_total_spent(category_id: int, user_id: int, session: Session):  
    expense_type = session.exec(  
        select(TransactionTypes).where(TransactionTypes.name == TransactionTypeEnums.expense)  
    ).first()  

    budgets = session.exec(  
        select(Budgets).where(  
            Budgets.category_id == category_id,  
            Budgets.user_id == user_id  
        )  
    ).all()  

    for budget in budgets:  
        total = session.exec(  
            select(func.sum(Transactions.amount)).where(  
                Transactions.user_id == budget.user_id,  
                Transactions.category_id == budget.category_id,  
                Transactions.transaction_type_id == expense_type.transaction_type_id,  
                Transactions.date.between(budget.start_date, budget.end_date)  
            )  
        ).first()  

        total = total if total is not None else 0.0  

        budget.total_spent = total  
        session.add(budget)  

        if total &lt;= budget.limit_amount:  
            session.exec(  
                delete(Notifications).where(  
                    Notifications.user_id == budget.user_id,  
                    Notifications.budget_id == budget.budget_id  
                )  
            )  
        else:  
            exists = session.exec(  
                select(Notifications).where(  
                    Notifications.user_id == budget.user_id,  
                    Notifications.budget_id == budget.budget_id  
                )  
            ).first()  
            if not exists:  
                session.add(  
                    Notifications(  
                        user_id = budget.user_id,  
                        budget_id = budget.budget_id,  
                        message = (  
                            f&quot;Бюджет по категории «{budget.category.name}» превышен: &quot;  
                            f&quot;потрачено {total}, лимит {budget.limit_amount}&quot;  
                        )  
                    )  
                )  
    session.commit()  


@router.patch(&quot;/{budget_id}&quot;, response_model = BudgetRead)  
def update_budget(  
    budget_id: int,  
    budget_update: BudgetUpdate,  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    budget = session.get(Budgets, budget_id)  
    if not budget:  
        raise HTTPException(status_code = 404, detail = &quot;Budget not found&quot;)  
    if budget.user_id != current_user.user_id:  
        raise HTTPException(status_code = 403, detail = &quot;Not authorized to update this budget&quot;)  

    data = budget_update.dict(exclude_unset = True)  
    if 'category_id' in data:  
        category = session.get(Categories, data['category_id'])  
        if not category or category.transaction_type.name != TransactionTypeEnums.expense:  
            raise HTTPException(status_code = 400, detail = &quot;Invalid expense category&quot;)  
    for k, v in data.items():  
        setattr(budget, k, v)  
    session.add(budget)  
    session.commit()  
    session.refresh(budget)  

    update_total_spent(  
        category_id = budget.category_id,  
        user_id = current_user.user_id,  
        session = session  
    )  
    return budget  


@router.delete(&quot;/{budget_id}&quot;)  
def delete_budget(  
    budget_id: int,  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    budget = session.get(Budgets, budget_id)  
    if not budget:  
        raise HTTPException(status_code = 404, detail = &quot;Budget not found&quot;)  
    if budget.user_id != current_user.user_id:  
        raise HTTPException(status_code = 403, detail = &quot;Not authorized to delete this budget&quot;)  
    session.delete(budget)  
    session.commit()  
    return {&quot;message&quot;: &quot;Budget deleted successfully&quot;}
</code></pre>
<h3 id="_6">Пример использования:</h3>
<ul>
<li>Пользователь <strong>Alex Johnson</strong> создает бюджет на категорию "groceries" с лимитом 350. После добавления транзакций на 200 и 250 (итого 450), система автоматически обновляет <code>total_spent</code> и создает уведомление о превышении бюджета.</li>
<li>Пользователь <strong>Bob Smith</strong> управляет бюджетом на "housing", где транзакция на 850 не превышает лимит 1000, и уведомление не создается.</li>
</ul>
<h2 id="_7">Результат</h2>
<p>Приложение успешно реализует базовый функционал для сервиса личных финансов. Все требования задания выполнены.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>